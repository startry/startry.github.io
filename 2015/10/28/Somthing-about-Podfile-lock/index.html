<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Podfile.lock背后的那点事 | Startry Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="大部分的iOS开发者应该都曾使用过CocoaPods去管理工程的依赖, 但是你们有没有留意一个小小的文件Podfile.lock呢?
通常我们需要使用CocoaPods去管理依赖, 都会执行一次pod install。 在install命令的执行过程中会改变被执行Project的配置项, 同时也会生产一个Podfile.lock文件。
那么, 这个Podfile.lock的作用究竟就是干嘛的呢?">
<meta property="og:type" content="article">
<meta property="og:title" content="Podfile.lock背后的那点事">
<meta property="og:url" content="http://startry.com/2015/10/28/Somthing-about-Podfile-lock/index.html">
<meta property="og:site_name" content="Startry Blog">
<meta property="og:description" content="大部分的iOS开发者应该都曾使用过CocoaPods去管理工程的依赖, 但是你们有没有留意一个小小的文件Podfile.lock呢?
通常我们需要使用CocoaPods去管理依赖, 都会执行一次pod install。 在install命令的执行过程中会改变被执行Project的配置项, 同时也会生产一个Podfile.lock文件。
那么, 这个Podfile.lock的作用究竟就是干嘛的呢?">
<meta property="og:image" content="http://blog.startry.com/img/blog_pod_update_help.png">
<meta property="og:updated_time" content="2015-10-28T07:09:00.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Podfile.lock背后的那点事">
<meta name="twitter:description" content="大部分的iOS开发者应该都曾使用过CocoaPods去管理工程的依赖, 但是你们有没有留意一个小小的文件Podfile.lock呢?
通常我们需要使用CocoaPods去管理依赖, 都会执行一次pod install。 在install命令的执行过程中会改变被执行Project的配置项, 同时也会生产一个Podfile.lock文件。
那么, 这个Podfile.lock的作用究竟就是干嘛的呢?">
  
    <link rel="alternative" href="/atom.xml" title="Startry Blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css" type="text/css">
  <script src="http://libs.baidu.com/jquery/1.9.0/jquery.js"></script>
</head>

<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img lazy-src="https://avatars2.githubusercontent.com/u/3454027?v=3&amp;s=460" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">Startry</a></h1>
		</hgroup>

		
		<p class="header-subtitle">随便乱写, 目前专攻iOS研发~</p>
		

		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						<div class="icon-wrap icon-link hide" data-idx="2">
							<div class="loopback_l"></div>
							<div class="loopback_r"></div>
						</div>
						
						
						<div class="icon-wrap icon-me hide" data-idx="3">
							<div class="user"></div>
							<div class="shoulder"></div>
						</div>
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>菜单</li>
						<li>标签</li>
						
						<li>友情链接</li>
						
						
						<li>关于我</li>
						
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives">所有文章</a></li>
				        
							<li><a href="/atom.xml">RSS</a></li>
				        
							<li><a href="/Sitemap.xml">Sitemap</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="github" target="_blank" href="http://github.com/startry" title="github">github</a>
					        
								<a class="weibo" target="_blank" href="http://weibo.com/chenxingstartry" title="weibo">weibo</a>
					        
								<a class="zhihu" target="_blank" href="http://www.zhihu.com/people/startry" title="zhihu">zhihu</a>
					        
								<a class="mail" target="_blank" href="mailto:chenxingfl#gmail.com" title="mail">mail</a>
					        
								<a class="twitter" target="_blank" href="https://twitter.com/xStartry" title="twitter">twitter</a>
					        
								<a class="stackoverflow" target="_blank" href="http://stackoverflow.com/users/5238614/startry" title="stackoverflow">stackoverflow</a>
					        
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/CocoaPods/" style="font-size: 16.67px;">CocoaPods</a> <a href="/tags/Jenkins/" style="font-size: 10px;">Jenkins</a> <a href="/tags/Ruby/" style="font-size: 13.33px;">Ruby</a> <a href="/tags/Screenshots/" style="font-size: 10px;">Screenshots</a> <a href="/tags/framework/" style="font-size: 13.33px;">framework</a> <a href="/tags/iOS/" style="font-size: 20px;">iOS</a> <a href="/tags/ios/" style="font-size: 20px;">ios</a> <a href="/tags/umbrella-header/" style="font-size: 10px;">umbrella header</a> <a href="/tags/xcconfig/" style="font-size: 13.33px;">xcconfig</a> <a href="/tags/随笔/" style="font-size: 13.33px;">随笔</a>
					</div>
				</section>
				
				
				
				<section class="switch-part switch-part3">
					<div id="js-friends">
					
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://github.com/startry">空荡荡的github</a>
			        
			        </div>
				</section>
				

				
				
				<section class="switch-part switch-part4">
				
					<div id="js-aboutme">混迹于各类互联网公司, 学习成长中, 边走边学~ 参与过某二手车公司创业, 也曾在某大型公司混的一花名&quot;玄书&quot;。现在重新学习成长中...</div>
				</section>
				
			</div>
		</div>
	</header>				
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">Startry</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				<img lazy-src="https://avatars2.githubusercontent.com/u/3454027?v=3&amp;s=460" class="js-avatar">
			</div>
			<hgroup>
			  <h1 class="header-author">Startry</h1>
			</hgroup>
			
			<p class="header-subtitle">随便乱写, 目前专攻iOS研发~</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives">所有文章</a></li>
		        
					<li><a href="/atom.xml">RSS</a></li>
		        
					<li><a href="/Sitemap.xml">Sitemap</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="http://github.com/startry" title="github">github</a>
			        
						<a class="weibo" target="_blank" href="http://weibo.com/chenxingstartry" title="weibo">weibo</a>
			        
						<a class="zhihu" target="_blank" href="http://www.zhihu.com/people/startry" title="zhihu">zhihu</a>
			        
						<a class="mail" target="_blank" href="mailto:chenxingfl#gmail.com" title="mail">mail</a>
			        
						<a class="twitter" target="_blank" href="https://twitter.com/xStartry" title="twitter">twitter</a>
			        
						<a class="stackoverflow" target="_blank" href="http://stackoverflow.com/users/5238614/startry" title="stackoverflow">stackoverflow</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>
      <div class="body-wrap"><article id="post-Somthing-about-Podfile-lock" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2015/10/28/Somthing-about-Podfile-lock/" class="article-date">
  	<time datetime="2015-10-28T07:09:00.000Z" itemprop="datePublished">2015-10-28</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Podfile.lock背后的那点事
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CocoaPods/">CocoaPods</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Ruby/">Ruby</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/iOS/">iOS</a></li></ul>
	</div>

        

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        
        
          <p>大部分的iOS开发者应该都曾使用过CocoaPods去管理工程的依赖, 但是你们有没有留意一个小小的文件<strong>Podfile.lock</strong>呢?</p>
<p>通常我们需要使用CocoaPods去管理依赖, 都会执行一次<code>pod install</code>。 在<code>install</code>命令的执行过程中会改变被执行Project的配置项, 同时也会生产一个Podfile.lock文件。</p>
<p>那么, 这个Podfile.lock的作用究竟就是干嘛的呢?</p>
<h2 id="初步窥探">初步窥探</h2><p>两个问题:</p>
<ol>
<li>什么是Podfile.lock呢? </li>
<li><code>pod install</code>和<code>pod update</code>在工作的时候又分别对Podfile.lock文件做了什么事情呢?</li>
</ol>
<h4 id="Podfile-lock的作用">Podfile.lock的作用</h4><p>熟悉CocoaPods的开发者都知道Podfile.lock是用来团队协作的, 防止库更新影响到其他协同开发的人。<a href="http://guides.cocoapods.org/using/using-cocoapods.html#what-is-podfilelock" target="_blank" rel="external">官方文档</a>描述该文件是用来追踪每一个生成Pod的版本的。原文如下:</p>
<blockquote>
<p>This file is generated after the first run of <font color="red"> pod install</font>, and tracks the version of each Pod that was installed. </p>
</blockquote>
<p>其实在<a href="http://weibo.com/tangqiaoboy" target="_blank" rel="external">@唐巧大神</a>博客<a href="http://www.devtang.com/blog/2014/05/25/use-cocoapod-to-manage-ios-lib-dependency/" target="_blank" rel="external">《用CocoaPods做iOS程序的依赖管理》</a>中有提到update和install的区别以及Podfile.lock的关系, 原文引用如下:</p>
<blockquote>
<p>当你执行pod install之后，除了 Podfile 外，CocoaPods 还会生成一个名为Podfile.lock的文件，Podfile.lock 应该加入到版本控制里面，不应该把这个文件加入到.gitignore中。因为Podfile.lock会锁定当前各依赖库的版本，之后如果多次执行pod install 不会更改版本，要pod update才会改Podfile.lock了。这样多人协作的时候，可以防止第三方库升级时造成大家各自的第三方库版本不一致</p>
</blockquote>
<h4 id="前置实验">前置实验</h4><p>这个已经基本总结了接下来我要做的一个实验, 但是对于很多人来说, 没有做够实验, 是无法深入去理解的, 因此我把接下来的初步窥探过程给罗列了出来:</p>
<p>Podfile文件写入如下执行语句:</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pod <span class="string">'STDebugConsole'</span>, <span class="string">'0.1.0'</span></span><br></pre></td></tr></table></figure>
<p>执行完后生成Podfile.lock文件如下:</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="constant">PODS</span><span class="symbol">:</span></span><br><span class="line">  - <span class="constant">STDebugConsole</span> (<span class="number">0</span>.<span class="number">1.0</span>)</span><br><span class="line"></span><br><span class="line"><span class="constant">DEPENDENCIES</span><span class="symbol">:</span></span><br><span class="line">  - <span class="constant">STDebugConsole</span> (= <span class="number">0</span>.<span class="number">1.0</span>)</span><br><span class="line"></span><br><span class="line"><span class="constant">SPEC</span> <span class="constant">CHECKSUMS</span><span class="symbol">:</span></span><br><span class="line">  <span class="constant">STDebugConsole</span><span class="symbol">:</span> <span class="number">57</span>c3e311e788dc1cb14f0c6aea33a931c00871cb</span><br><span class="line"></span><br><span class="line"><span class="constant">COCOAPODS</span><span class="symbol">:</span> <span class="number">0</span>.<span class="number">38.2</span></span><br></pre></td></tr></table></figure>
<p>修改原Podfile, 去掉后面的版本信息后重新执行<code>pod install</code>:</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pod <span class="string">'STDebugConsole'</span></span><br></pre></td></tr></table></figure>
<p>产生的Podfile.lock如下:</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="constant">PODS</span><span class="symbol">:</span></span><br><span class="line">  - <span class="constant">STDebugConsole</span> (<span class="number">0</span>.<span class="number">1.0</span>)</span><br><span class="line"></span><br><span class="line"><span class="constant">DEPENDENCIES</span><span class="symbol">:</span></span><br><span class="line">  - <span class="constant">STDebugConsole</span></span><br><span class="line"></span><br><span class="line"><span class="constant">SPEC</span> <span class="constant">CHECKSUMS</span><span class="symbol">:</span></span><br><span class="line">  <span class="constant">STDebugConsole</span><span class="symbol">:</span> <span class="number">57</span>c3e311e788dc1cb14f0c6aea33a931c00871cb</span><br><span class="line"></span><br><span class="line"><span class="constant">COCOAPODS</span><span class="symbol">:</span> <span class="number">0</span>.<span class="number">38.2</span></span><br></pre></td></tr></table></figure>
<p>对比可以发现<code>DEPENDENCIES</code>下的库没有了版本信息。</p>
<p>PS: 前面的步骤只是铺垫, 为了防止STDebugConsole库升级到最新的版本做的<font color="orange">前置步骤</font>。</p>
<h4 id="实验主体">实验主体</h4><p>修改Podfile文件, 添加至少大于某个版本的信息:</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pod <span class="string">'STDebugConsole'</span>, <span class="string">'~&gt; 0.1.0'</span></span><br></pre></td></tr></table></figure>
<p>重新执行<code>pod install</code>, 对比Podfile.lock文件如下:</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="constant">PODS</span><span class="symbol">:</span></span><br><span class="line">  - <span class="constant">STDebugConsole</span> (<span class="number">0</span>.<span class="number">1.0</span>)</span><br><span class="line"></span><br><span class="line"><span class="constant">DEPENDENCIES</span><span class="symbol">:</span></span><br><span class="line">  - <span class="constant">STDebugConsole</span> (~&gt; <span class="number">0</span>.<span class="number">1.0</span>)</span><br><span class="line"></span><br><span class="line"><span class="constant">SPEC</span> <span class="constant">CHECKSUMS</span><span class="symbol">:</span></span><br><span class="line">  <span class="constant">STDebugConsole</span><span class="symbol">:</span> <span class="number">57</span>c3e311e788dc1cb14f0c6aea33a931c00871cb</span><br><span class="line"></span><br><span class="line"><span class="constant">COCOAPODS</span><span class="symbol">:</span> <span class="number">0</span>.<span class="number">38.2</span></span><br></pre></td></tr></table></figure>
<p>我们可以发现基本的PODS版本信息都没有发生过变化, 只有DEPENDNCIES信息发生变化。</p>
<p>接下来我们重新执行一次<code>pod install</code>, 对比Podfile.lock发现并没有发生任何变化。这时候执行<code>pod update</code>, 可以发现STDebugConsole库的版本信息发生了变化。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="constant">PODS</span><span class="symbol">:</span></span><br><span class="line">  - <span class="constant">STDebugConsole</span> (<span class="number">0</span>.<span class="number">1.1</span>)</span><br><span class="line"></span><br><span class="line"><span class="constant">DEPENDENCIES</span><span class="symbol">:</span></span><br><span class="line">  - <span class="constant">STDebugConsole</span> (~&gt; <span class="number">0</span>.<span class="number">1.0</span>)</span><br><span class="line"></span><br><span class="line"><span class="constant">SPEC</span> <span class="constant">CHECKSUMS</span><span class="symbol">:</span></span><br><span class="line">  <span class="constant">STDebugConsole</span><span class="symbol">:</span> f07227199c0f906953e84f1d12e1fec4a9fc60d7</span><br><span class="line"></span><br><span class="line"><span class="constant">COCOAPODS</span><span class="symbol">:</span> <span class="number">0</span>.<span class="number">38.2</span></span><br></pre></td></tr></table></figure>
<p>通过上述几个实验, 可以得出:</p>
<p><strong>pod install只会将Podfile的信息写入到Podfile.lock, 但是不修改Pods已安装的依赖库的版本信息。pod update不但会将Podfile的信息写入到Podfile.lock文件中, 还会更新Pods已安装的依赖库的版本信息。</strong></p>
<h2 id="深入窥探">深入窥探</h2><p>Install和Update的区别大家都是知道了吧，但是它的背后究竟是怎么工作的呢? 如果大家有看过我之前写的<a href="http://blog.startry.com/2015/09/29/Something-about-Pod-Install-And-Pod-Update/" target="_blank" rel="external">《pod install和pod update背后那点事》</a>或者自己去研究过CocoaPods的<a href="https://github.com/CocoaPods/CocoaPods" target="_blank" rel="external">源码</a>, 就会发现在Pods源码下<code>pod installl</code>和<code>pod update</code>两个命令均在<a href="https://github.com/CocoaPods/CocoaPods/blob/0.39.0.beta.4/lib/cocoapods/command/project.rb" target="_blank" rel="external">project.rb</a>有所体现。</p>
<p>在project.rb中有两个继承Command的类, 分别叫做Update和Install, 用于分别执行<code>pod install</code>命令和<code>pod update</code>命令。Command类核心的执行方法是一个叫做<code>run</code>的方法, 在Update和Install类的run方法中均有调用到一个叫<code>run_install_with_update(update)</code>的方法。那么我们是否可以猜测, 在该方法中传递的布尔值正是决定Podfile.lock不同的地方之处呢?</p>
<p>呵呵, 核心的问题来了:</p>
<p><strong><code>run_install_with_update</code>方法的参数是怎么和Podfile.lock进行交互操作?</strong></p>
<p>想要知道答案? ╮(╯▽╰)╭ 没有什么好办法, 要不搜人家总结, 要么就只能去跟CocoaPods的源码了。</p>
<p>PS: 本文的源码依旧基于<a href="https://github.com/CocoaPods/CocoaPods/tree/0.39.0.beta.4" target="_blank" rel="external">CocoaPods Tag 0.39.0.beta.4</a>哦~~</p>
<p>跟踪Installer的update属性, 我们可以发现最终被传入了Analyzer类的update属性, 并通过一个<a href="https://github.com/CocoaPods/CocoaPods/blob/0.39.0.beta.4/lib/cocoapods/installer/analyzer.rb" target="_blank" rel="external">方法</a>重新定义返回了一个Ruby的<a href="http://www.ibm.com/developerworks/cn/opensource/os-cn-rubysbl/" target="_blank" rel="external">Symbol</a>类</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">update_mode</span></span></span><br><span class="line">  <span class="keyword">if</span> !update</span><br><span class="line">    <span class="symbol">:none</span></span><br><span class="line">  <span class="keyword">elsif</span> update == <span class="keyword">true</span></span><br><span class="line">    <span class="symbol">:all</span></span><br><span class="line">  <span class="keyword">elsif</span> !update[<span class="symbol">:pods</span>].<span class="keyword">nil</span>?</span><br><span class="line">    <span class="symbol">:selected</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>从上述代码, 我们可以看出, 如果执行Cocoapods的话, 会返回值为<code>:all</code>的Symbol, 因此我们使用<code>update_mode == :all</code>去搜索Analyzer这个类, 会发现在以下三个方法中被调用到:</p>
<ul>
<li><code>generate_version_locking_dependencies</code></li>
<li><code>pods_to_fetch</code></li>
<li><code>dependencies_to_fetch</code></li>
</ul>
<p>具体问题具体分析, 三个方法逐个击破:</p>
<h4 id="调用时机">调用时机</h4><ul>
<li><code>pods_to_fetch</code>在<code>dependencies_to_fetch</code>和<code>fetch_external_sources</code>方法中均有被调用, </li>
<li><code>dependencies_to_fetch</code>本身又只在<code>fetch_external_sources</code>方法中被调用</li>
<li><code>fetch_external_sources</code>和<code>generate_version_locking_dependencies</code>属于平行方法, 均在Analyzer类的核心方法analyze中被调用</li>
</ul>
<p>Analyzer类的核心方法<a href="https://github.com/CocoaPods/CocoaPods/blob/0.39.0.beta.4/lib/cocoapods/installer/analyzer.rb" target="_blank" rel="external">analyze</a>:</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">analyze</span><span class="params">(allow_fetches = <span class="keyword">true</span>)</span></span></span><br><span class="line">	validate_podfile!</span><br><span class="line">	validate_lockfile_version!</span><br><span class="line">	<span class="variable">@result</span> = <span class="constant">AnalysisResult</span>.new</span><br><span class="line">	<span class="keyword">if</span> config.integrate_targets?</span><br><span class="line">		<span class="variable">@result</span>.target_inspections = inspect_targets_to_integrate</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		verify_platforms_specified!</span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line">	<span class="variable">@result</span>.podfile_state = generate_podfile_state</span><br><span class="line">	<span class="variable">@locked_dependencies</span>  = generate_version_locking_dependencies</span><br><span class="line">	</span><br><span class="line">	store_existing_checkout_options</span><br><span class="line">	fetch_external_sources <span class="keyword">if</span> allow_fetches</span><br><span class="line">	<span class="variable">@result</span>.specs_by_target = validate_platforms(resolve_dependencies)</span><br><span class="line">	<span class="variable">@result</span>.specifications  = generate_specifications</span><br><span class="line">	<span class="variable">@result</span>.targets         = generate_targets</span><br><span class="line">	<span class="variable">@result</span>.sandbox_state   = generate_sandbox_state</span><br><span class="line">	<span class="variable">@result</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>Analyzer类的核心方法是在<code>resolve_dependencies</code>方法中被调用的, 该方法在我之前的文章<a href="http://blog.startry.com/2015/09/29/Something-about-Pod-Install-And-Pod-Update/" target="_blank" rel="external">《pod install和pod update背后那点事》</a>中有提到, 属于<code>pod install</code>背后执行的十大方法中的第二个方法, 在终端执行输出<code>Analyzing dependencies</code>的时候被调用执行。</p>
<h4 id="依赖Lock管理">依赖Lock管理</h4><p><code>generate_version_locking_dependencies</code><a href="https://github.com/CocoaPods/CocoaPods/blob/0.39.0.beta.4/lib/cocoapods/installer/analyzer.rb#L400" target="_blank" rel="external">源码</a>:</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">generate_version_locking_dependencies</span></span></span><br><span class="line">	<span class="keyword">if</span> update_mode == <span class="symbol">:all</span> || !lockfile</span><br><span class="line">		<span class="constant">LockingDependencyAnalyzer</span>.unlocked_dependency_graph</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		pods_to_update = result.podfile_state.changed + result.podfile_state.deleted</span><br><span class="line">		pods_to_update += update[<span class="symbol">:pods</span>] <span class="keyword">if</span> update_mode == <span class="symbol">:selected</span></span><br><span class="line">		pods_to_update += podfile.dependencies.select(&amp;<span class="symbol">:local?</span>).map(&amp;<span class="symbol">:name</span>)</span><br><span class="line">         </span><br><span class="line">		<span class="constant">LockingDependencyAnalyzer</span>.generate_version_locking_dependencies(lockfile, pods_to_update)</span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p><code>unlocked_dependency_graph</code><a href="https://github.com/CocoaPods/CocoaPods/blob/0.39.0.beta.4/lib/cocoapods/installer/analyzer/locking_dependency_analyzer.rb" target="_blank" rel="external">源码</a>:</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">unlocked_dependency_graph</span></span></span><br><span class="line">	<span class="constant">Molinillo::DependencyGraph</span>.new</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p><code>generate_version_locking_dependencies</code><a href="https://github.com/CocoaPods/CocoaPods/blob/0.39.0.beta.4/lib/cocoapods/installer/analyzer/locking_dependency_analyzer.rb#L20" target="_blank" rel="external">源码</a>:</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">generate_version_locking_dependencies</span><span class="params">(lockfile, pods_to_update)</span></span></span><br><span class="line">	dependency_graph = <span class="constant">Molinillo::DependencyGraph</span>.new</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> lockfile</span><br><span class="line">		explicit_dependencies = lockfile.to_hash[<span class="string">'DEPENDENCIES'</span>] || []</span><br><span class="line">		explicit_dependencies.each <span class="keyword">do</span> |string|</span><br><span class="line">			dependency = <span class="constant">Dependency</span>.new(string)</span><br><span class="line">			dependency_graph.add_root_vertex(dependency.name, <span class="keyword">nil</span>)</span><br><span class="line">		<span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">		pods = lockfile.to_hash[<span class="string">'PODS'</span>] || []</span><br><span class="line">		pods.each <span class="keyword">do</span> |pod|</span><br><span class="line">			add_to_dependency_graph(pod, [], dependency_graph)</span><br><span class="line">		<span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">		pods_to_update = pods_to_update.flat_map <span class="keyword">do</span> |u|</span><br><span class="line">			root_name = <span class="constant">Specification</span>.root_name(u).downcase</span><br><span class="line">			dependency_graph.vertices.keys.select &#123; |n| <span class="constant">Specification</span>.root_name(n).downcase == root_name &#125;</span><br><span class="line">		<span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">		pods_to_update.each <span class="keyword">do</span> |u|</span><br><span class="line">			dependency_graph.detach_vertex_named(u)</span><br><span class="line">		<span class="keyword">end</span></span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">	dependency_graph</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>通过上述源码, 可以看出update和install的区别分在<a href="https://github.com/CocoaPods/CocoaPods/blob/0.39.0.beta.4/lib/cocoapods/installer/analyzer/locking_dependency_analyzer.rb" target="_blank" rel="external">LockingDependencyAnalyzer</a>类的<a href="https://github.com/CocoaPods/CocoaPods/blob/0.39.0.beta.4/lib/cocoapods/installer/analyzer/locking_dependency_analyzer.rb#L53" target="_blank" rel="external"><code>unlocked_dependency_graph</code></a>和<a href="https://github.com/CocoaPods/CocoaPods/blob/0.39.0.beta.4/lib/cocoapods/installer/analyzer/locking_dependency_analyzer.rb#L20" target="_blank" rel="external"><code>generate_version_locking_dependencies</code></a>方法中。</p>
<ul>
<li><p>如果执行update操作, 执行<code>unlocked_dependency_graph</code>方法, 会返回一个全新的<a href="https://github.com/CocoaPods/Molinillo/blob/0.3.1/lib/molinillo/dependency_graph.rb" target="_blank" rel="external">Molinillo::DependencyGraph</a>对象; </p>
</li>
<li><p>如果执行install操作, 会执行下列操作:</p>
<ol>
<li>生成一个全新的Molinillo::DependencyGraph的对象</li>
<li>根据Podfile.lock加载所有需要Lock的依赖</li>
<li>根据外部预先处理的<code>pods_to_update</code>参数剔除需要更新的依赖</li>
<li>返回最终剔除的需要更新后的所有需要锁定的依赖</li>
</ol>
</li>
</ul>
<p>PS: 此处的<a href="https://github.com/CocoaPods/Molinillo/tree/0.3.1" target="_blank" rel="external">Molinillo</a>是CocoaPods的另外一个子项目, 专门用于处理CocoaPods的依赖关系, 引用官方介绍如下:</p>
<blockquote>
<p>A generic dependency-resolution implementation.</p>
</blockquote>
<h4 id="检测依赖改动">检测依赖改动</h4><p>从依赖Lock管理章节可以看出, 在已有Podfile的前提下, 是需要根据<code>pods_to_updte</code>这个参数来进行控制调整。结合<code>generate_version_locking_dependencies</code>的源码分析, 咱们可以看出满足需要更新的条件是以下任一一个:</p>
<ol>
<li>Podfile的状态是<font color="orange">changed</font>和<font color="orange">deleted</font>的依赖</li>
<li>被预先标记需要需要的库(update参数属于数组的情况下)</li>
<li>在Podfile中被指定<code>:local</code>参数的库</li>
</ol>
<p>第一条和第三条都比较好理解, 但是第二条update参数属于数组的情况下, 怎么理解呢?</p>
<p>首先, 这个update是个什么鬼? update是在外部方法<code>run_install_with_update</code>中传入的参数, 该参数可能是个数组, 可能是个BOOL值, 在这里我们回归以下Update这个Command的类的<a href="https://github.com/CocoaPods/CocoaPods/blob/0.39.0.beta.4/lib/cocoapods/command/project.rb#L107" target="_blank" rel="external">实现</a>:</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Update</span> <span class="inheritance">&lt; <span class="parent">Command</span></span></span></span><br><span class="line"><span class="comment"># ... 省略</span></span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">initialize</span><span class="params">(argv)</span></span></span><br><span class="line">		<span class="variable">@pods</span> = argv.arguments! <span class="keyword">unless</span> argv.arguments.empty?</span><br><span class="line">		<span class="keyword">super</span></span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">run</span></span></span><br><span class="line">		verify_podfile_exists!</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> <span class="variable">@pods</span></span><br><span class="line">          verify_lockfile_exists!</span><br><span class="line">	</span><br><span class="line">          <span class="comment">#... 省略</span></span><br><span class="line"></span><br><span class="line">          run_install_with_update(<span class="symbol">:pods</span> =&gt; <span class="variable">@pods</span>)</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">          <span class="constant">UI</span>.puts <span class="string">'Update all pods'</span>.yellow <span class="keyword">unless</span> <span class="variable">@pods</span></span><br><span class="line">          run_install_with_update(<span class="keyword">true</span>)</span><br><span class="line">		<span class="keyword">end</span></span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#... 省略</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>从上述Update类的实现可以看出<code>:pods</code>这个属性是根据命令行参数读取的, 呵呵, 熟悉<code>pod update</code>命令的程序猿们是否已经猜出了大概, 不多说, 敲入以下命令看结果:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pod update --help</span><br></pre></td></tr></table></figure>
<p><img src="http://blog.startry.com/img/blog_pod_update_help.png" alt="pod update help"></p>
<p>原来update数组里面存的是命令行显示指定的库的集合。</p>
<p>那么到目前为止问题都解决了么, 没有! 会触发更新的三个任意条件的第一条, Podfile的state又是怎么计算出来的呢? changed和deleted是依据什么去标记的呢?</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">run_install_with_update</span><span class="params">(update)</span></span></span><br><span class="line">	installer = <span class="constant">Installer</span>.new(config.sandbox, config.podfile, config.lockfile)</span><br><span class="line">	installer.update = update</span><br><span class="line">	installer.install!</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>通过<code>run_install_with_update</code>的<a href="https://github.com/CocoaPods/CocoaPods/blob/0.39.0.beta.4/lib/cocoapods/command/project.rb#L68" target="_blank" rel="external">实现</a>, 我们可以看出来大部分的文件都是config里预先记载的。而在<a href="https://github.com/CocoaPods/CocoaPods/blob/0.39.0.beta.4/lib/cocoapods/config.rb" target="_blank" rel="external">config.rb</a>的实现中有如下代码:</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">podfile</span></span></span><br><span class="line">	<span class="variable">@podfile</span> ||= <span class="constant">Podfile</span>.from_file(podfile_path) <span class="keyword">if</span> podfile_path</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="keyword">attr_writer</span> <span class="symbol">:podfile</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">lockfile</span></span></span><br><span class="line">	<span class="variable">@lockfile</span> ||= <span class="constant">Lockfile</span>.from_file(lockfile_path) <span class="keyword">if</span> lockfile_path</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>Podfile类和Lockfile的类的定义都无法在CocoaPods工程中搜索出来。笔者通过在CocoaPods依赖库的模糊搜索, 找出该两个库隐藏在CocoaPods下的<a href="https://github.com/CocoaPods/Core" target="_blank" rel="external">Core</a>依赖工程中。</p>
<p>T_T ~ 好吧, 只能继续clone依赖工程了</p>
<p>找到了Lockfile类和Podfile类, 下一步就是定位状态变化是在哪里的哇。在文章前半部分提到的Analyzer类的analyze方法中有个<a href="https://github.com/CocoaPods/CocoaPods/blob/0.39.0.beta.4/lib/cocoapods/installer/analyzer.rb#L190" target="_blank" rel="external"><code>generate_podfile_state</code></a>方法的调用。 看名字就像是生成状态的地方, 我们跟进去这个方法可以找出该方法的核心在于Lockfile类的<a href="https://github.com/CocoaPods/Core/blob/0.39.0.beta.4/lib/cocoapods-core/lockfile.rb#L255" target="_blank" rel="external"><code>detect_changes_with_podfile</code></a>方法。</p>
<p>Lockfile检测状态变化核心<a href="https://github.com/CocoaPods/Core/blob/0.39.0.beta.4/lib/cocoapods-core/lockfile.rb#L255" target="_blank" rel="external">源码</a>:</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">detect_changes_with_podfile</span><span class="params">(podfile)</span></span></span><br><span class="line">	result = &#123;&#125;</span><br><span class="line">	[<span class="symbol">:added</span>, <span class="symbol">:changed</span>, <span class="symbol">:removed</span>, <span class="symbol">:unchanged</span>].each &#123; |k| result[k] = [] &#125;</span><br><span class="line"></span><br><span class="line">	installed_deps = dependencies.map <span class="keyword">do</span> |dep|</span><br><span class="line">		dependencies_to_lock_pod_named(dep.root_name)</span><br><span class="line">	<span class="keyword">end</span>.flatten</span><br><span class="line">	all_dep_names  = (dependencies + podfile.dependencies).map(&amp;<span class="symbol">:name</span>).uniq</span><br><span class="line">	all_dep_names.each <span class="keyword">do</span> |name|</span><br><span class="line">		installed_dep = installed_deps.find &#123; |d| d.name == name &#125;</span><br><span class="line">		podfile_dep   = podfile.dependencies.find &#123; |d| d.name == name &#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> installed_dep.<span class="keyword">nil</span>?  <span class="keyword">then</span> key = <span class="symbol">:added</span></span><br><span class="line">		<span class="keyword">elsif</span> podfile_dep.<span class="keyword">nil</span>? <span class="keyword">then</span> key = <span class="symbol">:removed</span></span><br><span class="line">		<span class="keyword">elsif</span> podfile_dep.compatible?(installed_dep) <span class="keyword">then</span> key = <span class="symbol">:unchanged</span></span><br><span class="line">		<span class="keyword">else</span> key = <span class="symbol">:changed</span></span><br><span class="line">		<span class="keyword">end</span></span><br><span class="line">		result[key] &lt;&lt; name</span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line">	result</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>上述源码大概意思如下:</p>
<ul>
<li>:added - Podfile中的依赖库<strong>名字</strong>在Lockfile没有被描述记载 (仅仅对比名字)</li>
<li>:removed - Lockfile中已记载的依赖库的<strong>名字</strong>没有在Podfile文件中写明 (仅仅对比名字)</li>
<li>:unchanged - 通过<a href="https://github.com/CocoaPods/Core/blob/0.39.0.beta.4/lib/cocoapods-core/dependency.rb" target="_blank" rel="external">Dependency</a>类的<code>compatible</code>不为真的时候</li>
<li>:changed - 不满足上述三个条件其他任意情况</li>
</ul>
<p>好了, 大致的对比方法已经了解了, 就看<a href="https://github.com/CocoaPods/Core/blob/0.39.0.beta.4/lib/cocoapods-core/dependency.rb#L178" target="_blank" rel="external"><code>compatible</code></a>怎么理解了!</p>
<p>Dependency 类的<code>compatible</code>方法<a href="https://github.com/CocoaPods/Core/blob/0.39.0.beta.4/lib/cocoapods-core/dependency.rb#L178" target="_blank" rel="external">源码:</a></p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">compatible?</span><span class="params">(other)</span></span></span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">false</span> <span class="keyword">unless</span> name == other.name</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">false</span> <span class="keyword">unless</span> head? == other.head?</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">false</span> <span class="keyword">unless</span> external_source == other.external_source</span><br><span class="line"></span><br><span class="line">	other.requirement.requirements.all? <span class="keyword">do</span> |_operator, version|</span><br><span class="line">		requirement.satisfied_by? <span class="constant">Version</span>.new(version)</span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>Requirement 类的<code>requirement.satisfied_by</code>方法<a href="https://github.com/CocoaPods/Core/blob/0.39.0.beta.4/lib/cocoapods-core/dependency.rb#L178" target="_blank" rel="external">源码:</a></p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">satisfied_by?</span> <span class="title">version</span></span></span><br><span class="line">	raise <span class="constant">ArgumentError</span>, <span class="string">"Need a Gem::Version: <span class="subst">#&#123;version.inspect&#125;</span>"</span> <span class="keyword">unless</span></span><br><span class="line">		<span class="constant">Gem::Version</span> === version</span><br><span class="line"><span class="comment"># #28965: syck has a bug with unquoted '=' YAML.loading as YAML::DefaultKey</span></span><br><span class="line">	requirements.all? &#123; |op, rv| (<span class="constant">OPS</span>[op] || <span class="constant">OPS</span>[<span class="string">"="</span>]).call version, rv &#125;</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>PS: <a href="https://github.com/CocoaPods/Core/blob/0.39.0.beta.4/lib/cocoapods-core/vendor/requirement.rb#L18" target="_blank" rel="external">OPS</a>是一个预先定义的字符和字符对应的lambda操作映射的数组。</p>
<p>通过上面的方法定义, 我们可以看出<code>compatible</code>方法实际上是对库名字, ext标志、 head描述和版本操作符进行比较。</p>
<ul>
<li>ext、head是啥? 哈哈, 可以自己去Podfile里面对应喔~ 也可以下载代码去查找定义哇~ (如果大家没有用过这两个东西, 建议先去熟悉使用CocoaPods工具)</li>
</ul>
<p><code>detect_changes_with_podfile</code>方法已经将Pods库响应的变化均记录在内存变量中, 供后续修改Podfile.lock, 更新依赖库等各个行为使用。</p>
<p>因为继续跟踪源码文章篇幅偏长并且可阅读性也不高, 作者就打算偷个懒, 不继续跟踪源码, 如果有需要另起文章跟踪其它部分源码。</p>
<p>大家可以自己根据上述的思路进行更加深入的跟踪哇~</p>
<h2 id="总结">总结</h2><p>CocoaPods大多数人都会用, 但是并不是每一个人都理解其每一个文件的作用, Podfile.lock就是其中一个典型的例子。一开始我也无意研究Podfile.lock文件的作用, 起因是之前换工作的时候遇到一位面试的朋友对其追问而无法精确回答。</p>
<p>Podfile.lock文件对团队协作非常作用, 应该添加进入源码依赖。<code>pod install</code>和<code>pod update</code>都是基于Podfile.lock进行约束。<strong>install会根据一定的规则和Podfile.lock文件进行依赖库的约束下载, 同时细微更新Podfile.lock文件; update会根据另外一套规则进行约束库的下载和对Podfile.lock的写入更新。</strong></p>
<p>Podfile.lock的作用很明显, 为了相互之间协作更加通畅; 但是, Podfile.lock文件背后的工作以及作用并不是一两句话能够总结的出来, 希望大家能够理解~</p>
<p>-<br>另: 源码分析是具有时效性, 但是分析的方法和核心的思想不会发生太大的变化, 掌握分析的方法和理解设计的核心思想才是关键~</p>
<p>PS: 个人水平有限, 如果发现错误之处, 请大家及时指出~~ 谢谢哈~</p>
<p>PS: 因为本文写的特别凌乱, 如果有啥看不懂的~ 也一定要告诉我哇~~ 会持续修正文章~~</p>
<h4 id="参考文献">参考文献</h4><ol>
<li><a href="http://www.devtang.com/blog/2014/05/25/use-cocoapod-to-manage-ios-lib-dependency/" target="_blank" rel="external">用CocoaPods做iOS程序的依赖管理</a></li>
<li><a href="https://github.com/CocoaPods/CocoaPods/tree/0.39.0.beta.4" target="_blank" rel="external">CocoaPods源码库</a></li>
<li><a href="http://www.ibm.com/developerworks/cn/opensource/os-cn-rubysbl/" target="_blank" rel="external">IBM developerWorks - 理解 Ruby Symbol，第 1 部分</a></li>
</ol>

        
      
    </div>
    
  </div>

  
    <!-- 添加打赏逻辑 -->
    <div class='dashang' style='text-align:center; height:50px;'>如果您觉得文章有用, 打赏一个呗~~ ( ⊙ o ⊙ )/</div>
    <div class='dashang_alipay' style='text-align:center;'>
      <form action="https://shenghuo.alipay.com/send/payment/fill.htm"
    method="POST" target="_blank" accept-charset="GBK">
        <input name="optEmail" type="hidden" value="148140274@qq.com" />
        <input name="payAmount" type="hidden" value="1" />
        <input id="title" name="title" type="hidden" value="来自Startry博文的打赏" />
        <input name="memo" type="hidden" value="打赏以资鼓励~~ O(∩_∩)O" />
        <input name="pay" type="image" value="转账"
      src="https://img.alipay.com/sys/personalprod/style/mc/btn-index.png" />
      </form>
    </div>
    <div style='text-align:center; margin-top: 20px;'>
      <img src='/img/wechat_pay.png' style='width: 160px; height:160px; margin-right: 15px;'>
      <img src='/img/alipay_pay.png' style='width: 160px; height:160px; margin-left: 15px;  '>
    </div>
    
<nav id="article-nav">
  
    <a href="/2015/12/03/Power-source-of-writing/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption"><</strong>
      <div class="article-nav-title">
        
          搭建博客的简单自述
        
      </div>
    </a>
  
  
    <a href="/2015/09/29/Something-about-Pod-Install-And-Pod-Update/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">pod install和pod update背后那点事</div>
      <strong class="article-nav-caption">></strong>
    </a>
  
</nav>

  
</article>


<div class="share">
	<!-- JiaThis Button BEGIN -->
	<div class="jiathis_style">
		<span class="jiathis_txt">分享到：</span>
		<a class="jiathis_button_tsina"></a>
		<a class="jiathis_button_cqq"></a>
		<a class="jiathis_button_douban"></a>
		<a class="jiathis_button_weixin"></a>
		<a class="jiathis_button_tumblr"></a>
		<a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jtico jtico_jiathis" target="_blank"></a>
	</div>
	<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=1405949716054953" charset="utf-8"></script>
	<!-- JiaThis Button END -->
</div>



<div class="duoshuo">
	<!-- 多说评论框 start -->
	<div class="ds-thread" data-thread-key="Somthing-about-Podfile-lock" data-title="Podfile.lock背后的那点事" data-url="http://startry.com/2015/10/28/Somthing-about-Podfile-lock/"></div>
	<!-- 多说评论框 end -->
	<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
	<script type="text/javascript">
	var duoshuoQuery = {short_name:"true"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
	<!-- 多说公共JS代码 end -->
</div>




</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2016 Startry
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
  <div style="display:none">
    <span id="busuanzi_container_site_pv" style="display:hidden;">本站总访问量<span id="busuanzi_value_site_pv"></span>次
    </span>
    <span id="busuanzi_container_site_uv">本站访客数<span id="busuanzi_value_site_uv"></span>人次
    </span>
  </div>
</footer>
<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>

    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">


<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: true,
		animate: true,
		isHome: false,
		isPost: true,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	}
</script>
<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js" type="text/javascript"></script>
<script src="/js/main.js" type="text/javascript"></script>



<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-67055063-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->




<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  </div>
</body>
</html>